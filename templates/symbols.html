{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="bg-white shadow-xl rounded-2xl p-8">
        <h2 class="text-3xl font-extrabold text-gray-800 mb-6 flex items-center gap-3">
            <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" stroke-width="2"
                 viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
            </svg>
            Manage Symbols
        </h2>

        <!-- Add/Edit Symbol Form -->
        <form id="addSymbolForm" action="/symbols" method="POST"
              class="mb-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 bg-gray-50 p-6 rounded-xl border border-gray-200 relative">

            <div class="relative col-span-1 sm:col-span-2 lg:col-span-1">
                <label class="block text-sm font-semibold text-gray-700 mb-1">Symbol</label>
                <input id="symbolInput" type="text" name="new_symbol" placeholder="Search symbol..." 
                       class="border-gray-300 rounded-lg p-2 w-full focus:ring-2 focus:ring-green-400 focus:outline-none" autocomplete="off" required>
                <div id="symbolDropdown" class="absolute left-0 right-0 bg-white border border-gray-300 rounded max-h-40 overflow-y-auto z-50 mt-1 shadow-lg hidden">
                    {% for sym in broker_symbols %}
                        <div class="px-2 py-1 hover:bg-gray-200 cursor-pointer">{{ sym }}</div>
                    {% endfor %}
                </div>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-1">Lot Size</label>
                <input type="number" name="lot_size" step="0.0001" min="0.0001" value="0.1000" class="border rounded p-2 w-full" required>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-1">Brick Size</label>
                <input type="number" name="brick_size" step="0.0001" min="0.0001" value="0.1000" class="border rounded p-2 w-full" required>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-1">Max Up</label>
                <input type="number" name="max_up" min="1" value="5" class="border rounded p-2 w-full" required>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-1">Max Down</label>
                <input type="number" name="max_down" min="1" value="5" class="border rounded p-2 w-full" required>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-1">Trade Side</label>
                <select name="trade_side" class="border rounded p-2 w-full">
                    <option value="both" selected>Both</option>
                    <option value="buy">Only Buy</option>
                    <option value="sell">Only Sell</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-1">SL (pips)</label>
                <input type="number" name="stop_loss_pips" step="0.0001" value="0.1000" class="border rounded p-2 w-full">
            </div>
            <div>
                <label class="block text-sm font-semibold mb-1">TP (pips)</label>
                <input type="number" name="take_profit_pips" step="0.0001" value="0.1000" class="border rounded p-2 w-full">
            </div>
            <div>
                <label class="block text-sm font-semibold mb-1">Trailing SL</label>
                <input type="number" name="trailing_stop_pips" step="0.0001" value="0.1000" class="border rounded p-2 w-full">
            </div>

            <div class="col-span-1 sm:col-span-2 lg:col-span-1 flex items-end">
                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded w-full font-semibold shadow">
                    âž• Add / Update Symbol
                </button>
            </div>
        </form>

        <!-- Existing Symbols Table -->
        <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-sm">
            <table class="w-full border-collapse text-sm">
                <thead>
                    <tr class="bg-green-100 text-green-900">
                        <th class="border px-4 py-3 text-left">Symbol</th>
                        <th class="border px-4 py-3">Lot</th>
                        <th class="border px-4 py-3">Brick</th>
                        <th class="border px-4 py-3">Max Up</th>
                        <th class="border px-4 py-3">Max Down</th>
                        <th class="border px-4 py-3">Trade Side</th>
                        <th class="border px-4 py-3">SL</th>
                        <th class="border px-4 py-3">TP</th>
                        <th class="border px-4 py-3">Trailing SL</th>
                        <th class="border px-4 py-3 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sym in symbols %}
                    <tr class="hover:bg-gray-50">
                        <td class="border px-4 py-3 font-bold">{{ sym.name }}</td>
                        <td class="border px-4 py-3">{{ sym.lot_size }}</td>
                        <td class="border px-4 py-3">{{ "%.4f"|format(sym.brick_size) }}</td>
                        <td class="border px-4 py-3">{{ sym.max_up }}</td>
                        <td class="border px-4 py-3">{{ sym.max_down }}</td>
                        <td class="border px-4 py-3">{{ sym.trade_side }}</td>
                        <td class="border px-4 py-3">{{ "%.4f"|format(sym.stop_loss_pips) if sym.stop_loss_pips else "â€”" }}</td>
                        <td class="border px-4 py-3">{{ "%.4f"|format(sym.take_profit_pips) if sym.take_profit_pips else "â€”" }}</td>
                        <td class="border px-4 py-3">{{ "%.4f"|format(sym.trailing_stop_pips) if sym.trailing_stop_pips else "â€”" }}</td>
                        <td class="border px-4 py-3 text-center">
                            <div class="flex flex-wrap justify-center gap-2">
                                <!-- Toggle Trading -->
                                <button data-symbol="{{ sym.name }}" 
                                        class="toggle-trading-btn transition-colors duration-200 px-3 py-2 rounded-lg text-sm font-medium shadow-sm flex items-center gap-1
                                        {% if sym.active %}bg-green-500 hover:bg-green-600 text-white{% else %}bg-gray-400 hover:bg-gray-500 text-white{% endif %}">
                                    {% if sym.active %}ðŸŸ¢ Active{% else %}ðŸ”´ Stopped{% endif %}
                                </button>

                                <!-- Panic Close -->
                                <button data-symbol="{{ sym.name }}" class="panic-close-btn transition-colors duration-200 px-3 py-2 rounded-lg text-sm font-medium shadow-sm flex items-center gap-1 bg-red-500 hover:bg-red-600 text-white">
                                    âš  Panic Close
                                </button>

                                <!-- Cancel Orders -->
                                <button data-symbol="{{ sym.name }}" class="cancel-orders-btn transition-colors duration-200 px-3 py-2 rounded-lg text-sm font-medium shadow-sm flex items-center gap-1 bg-yellow-400 hover:bg-yellow-500 text-gray-900">
                                    âœ– Cancel Orders
                                </button>

                                <!-- Edit -->
                                <button data-symbol="{{ sym.name }}" class="edit-symbol-btn transition-colors duration-200 px-3 py-2 rounded-lg text-sm font-medium shadow-sm flex items-center gap-1 bg-blue-500 hover:bg-blue-600 text-white">
                                    âœŽ Edit
                                </button>

                                <!-- Remove -->
                                <form method="POST" class="m-0">
                                    <input type="hidden" name="remove_symbol" value="{{ sym.name }}">
                                    <button type="submit" class="transition-colors duration-200 px-3 py-2 rounded-lg text-sm font-medium shadow-sm flex items-center gap-1 bg-gray-500 hover:bg-gray-600 text-white">
                                        ðŸ—‘ Remove
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" class="text-center py-6 text-gray-500">No symbols added yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// --- Symbol Dropdown ---
const input = document.getElementById('symbolInput');
const dropdown = document.getElementById('symbolDropdown');
const items = dropdown.querySelectorAll('div');

input.addEventListener('focus', () => dropdown.classList.remove('hidden'));
document.addEventListener('click', e => {
    if (!dropdown.contains(e.target) && e.target !== input) dropdown.classList.add('hidden');
});
input.addEventListener('input', () => {
    const val = input.value.toLowerCase();
    let hasMatch = false;
    items.forEach(item => {
        const match = item.textContent.toLowerCase().includes(val);
        item.style.display = match ? 'block' : 'none';
        if(match) hasMatch = true;
    });
    dropdown.classList.toggle('hidden', !hasMatch);
});
items.forEach(item => item.addEventListener('mousedown', e => {
    e.preventDefault();
    input.value = item.textContent;
    dropdown.classList.add('hidden');
}));

// --- Edit Button ---
document.querySelectorAll(".edit-symbol-btn").forEach(btn => {
    btn.addEventListener('click', () => {
        const row = btn.closest('tr');
        input.value = row.children[0].textContent;
        document.querySelector('input[name="lot_size"]').value = row.children[1].textContent;
        document.querySelector('input[name="brick_size"]').value = parseFloat(row.children[2].textContent).toFixed(4);
        document.querySelector('input[name="max_up"]').value = row.children[3].textContent;
        document.querySelector('input[name="max_down"]').value = row.children[4].textContent;
        document.querySelector('select[name="trade_side"]').value = row.children[5].textContent;
        document.querySelector('input[name="stop_loss_pips"]').value = row.children[6].textContent !== "â€”" ? parseFloat(row.children[6].textContent).toFixed(4) : "";
        document.querySelector('input[name="take_profit_pips"]').value = row.children[7].textContent !== "â€”" ? parseFloat(row.children[7].textContent).toFixed(4) : "";
        document.querySelector('input[name="trailing_stop_pips"]').value = row.children[8].textContent !== "â€”" ? parseFloat(row.children[8].textContent).toFixed(4) : "";
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
});

// --- Toggle Trading Button ---
document.querySelectorAll(".toggle-trading-btn").forEach(btn => {
    btn.addEventListener('click', async () => {
        const symbol = btn.dataset.symbol;

        const res = await fetch("/symbols/toggle", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ symbol })
        });

        const data = await res.json();
        if(data.success) {
            if(data.active) {
                btn.classList.remove("bg-gray-400", "hover:bg-gray-500");
                btn.classList.add("bg-green-500", "hover:bg-green-600");
                btn.textContent = "ðŸŸ¢ Active";
            } else {
                btn.classList.remove("bg-green-500", "hover:bg-green-600");
                btn.classList.add("bg-gray-400", "hover:bg-gray-500");
                btn.textContent = "ðŸ”´ Stopped";
            }
        }
    });
});
</script>
{% endblock %}
