{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="bg-white shadow-xl rounded-2xl p-8">
        <h2 class="text-3xl font-extrabold text-gray-800 mb-6 flex items-center gap-3">
            <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
            </svg>
            Manage Symbols
        </h2>

        <!-- Add/Edit Symbol Form -->
        <form id="addSymbolForm" action="/symbols" method="POST"
              class="mb-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 bg-gray-50 p-6 rounded-xl border border-gray-200 relative">

            <div class="relative col-span-1 sm:col-span-2 lg:col-span-1">
                <label class="block text-sm font-semibold text-gray-700 mb-1">Symbol</label>
                <input id="symbolInput" type="text" name="new_symbol" placeholder="Search symbol..." 
                       class="border-gray-300 rounded-lg p-2 w-full focus:ring-2 focus:ring-green-400 focus:outline-none" autocomplete="off" required>
                <div id="symbolDropdown" class="absolute left-0 right-0 bg-white border border-gray-300 rounded max-h-40 overflow-y-auto z-50 mt-1 shadow-lg hidden">
                    {% for sym in broker_symbols %}
                        <div class="px-2 py-1 hover:bg-gray-200 cursor-pointer">{{ sym }}</div>
                    {% endfor %}
                </div>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-1">Lot Size</label>
                <input type="number" name="lot_size" step="0.0001" min="0.0001" value="0.1000" class="border rounded p-2 w-full" required>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-1">Brick Size</label>
                <input type="number" name="brick_size" step="0.0001" min="0.0001" value="0.1000" class="border rounded p-2 w-full" required>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-1">Max Up</label>
                <input type="number" name="max_up" min="1" value="5" class="border rounded p-2 w-full" required>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-1">Max Down</label>
                <input type="number" name="max_down" min="1" value="5" class="border rounded p-2 w-full" required>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-1">Trade Side</label>
                <select name="trade_side" class="border rounded p-2 w-full">
                    <option value="both" selected>Both</option>
                    <option value="buy">Only Buy</option>
                    <option value="sell">Only Sell</option>
                </select>
            </div>

            <!-- Stop Loss with radio options -->
            <div class="col-span-1 sm:col-span-2 lg:col-span-1">
                <label class="block text-sm font-semibold mb-1">Stop Loss</label>
                <div class="mb-2 text-sm">
                    <label class="inline-flex items-center mr-3">
                        <input type="radio" name="stop_loss_mode" value="same_price" checked class="mr-2 stoploss-mode"> Same as price (0.0)
                    </label>
                    <label class="inline-flex items-center mr-3">
                        <input type="radio" name="stop_loss_mode" value="no_stop" class="mr-2 stoploss-mode"> No stop loss
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="stop_loss_mode" value="custom" class="mr-2 stoploss-mode"> My stop loss
                    </label>
                </div>

                <!-- VISIBLE input: for user display / editing (no name so it won't be submitted) -->
                <input id="stopLossInput" type="number" step="0.0001" min="0.0001" placeholder="Enter stop loss (> 0.0)" class="border rounded p-2 w-full" value="0.0" readonly>

                <!-- HIDDEN input: this one carries the actual submitted value -->
                <input id="stopLossHidden" type="hidden" name="stop_loss_pips" value="0.0">

                <p id="stopLossHelp" class="text-xs text-gray-500 mt-1">Select mode. "Same as price" sets 0.0; "No stop loss" will send null; "My stop loss" requires &gt; 0.</p>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-1">TP (pips)</label>
                <input type="number" name="take_profit_pips" step="0.0001" value="0.1000" class="border rounded p-2 w-full">
            </div>
            <div>
                <label class="block text-sm font-semibold mb-1">Trailing SL</label>
                <input type="number" name="trailing_stop_pips" step="0.0001" value="0.1000" class="border rounded p-2 w-full">
            </div>

            <!-- NEW: Far Close radio (sends farClose=true or farClose=false to backend) -->
            <div class="col-span-1 sm:col-span-2 lg:col-span-1">
                <label class="block text-sm font-semibold mb-1">Far Close</label>
                <div class="mb-2 text-sm">
                    <label class="inline-flex items-center mr-3">
                        <input type="radio" name="farClose" value="true" class="mr-2 farclose-radio" checked> Active
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="farClose" value="false" class="mr-2 farclose-radio"> Inactive
                    </label>
                </div>
                <p class="text-xs text-gray-500 mt-1">When Active, backend will run far-close cleaning for this symbol.</p>
            </div>

            <div class="col-span-1 sm:col-span-2 lg:col-span-1 flex items-end">
                <button id="addUpdateBtn" type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded w-full font-semibold shadow">
                    ➕ Add / Update Symbol
                </button>
            </div>
        </form>

        <!-- Existing Symbols Table -->
        <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-sm">
            <table class="w-full border-collapse text-sm">
                <thead>
                    <tr class="bg-green-100 text-green-900">
                        <th class="border px-4 py-3 text-left">Symbol</th>
                        <th class="border px-4 py-3">Lot</th>
                        <th class="border px-4 py-3">Brick</th>
                        <th class="border px-4 py-3">Max Up</th>
                        <th class="border px-4 py-3">Max Down</th>
                        <th class="border px-4 py-3">Trade Side</th>
                        <th class="border px-4 py-3">SL</th>
                        <th class="border px-4 py-3">TP</th>
                        <th class="border px-4 py-3">Trailing SL</th>
                        <th class="border px-4 py-3 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sym in symbols %}
                    <!-- data-farclose added so JS can read current value when editing -->
                    <tr class="hover:bg-gray-50" data-farclose="{{ 'true' if sym.farClose else 'false' }}">
                        <td class="border px-4 py-3 font-bold">{{ sym.name }}</td>
                        <td class="border px-4 py-3">{{ sym.lot_size }}</td>
                        <td class="border px-4 py-3">{{ "%.4f"|format(sym.brick_size) }}</td>
                        <td class="border px-4 py-3">{{ sym.max_up }}</td>
                        <td class="border px-4 py-3">{{ sym.max_down }}</td>
                        <td class="border px-4 py-3">{{ sym.trade_side }}</td>
                        <td class="border px-4 py-3">{{ "%.4f"|format(sym.stop_loss_pips) if sym.stop_loss_pips is not none else "—" }}</td>
                        <td class="border px-4 py-3">{{ "%.4f"|format(sym.take_profit_pips) if sym.take_profit_pips else "—" }}</td>
                        <td class="border px-4 py-3">{{ "%.4f"|format(sym.trailing_stop_pips) if sym.trailing_stop_pips else "—" }}</td>
                        <td class="border px-4 py-3 text-center">
                            <div class="flex flex-wrap justify-center gap-2">
                                <!-- Toggle Trading -->
                                <button data-symbol="{{ sym.name }}" 
                                        class="toggle-trading-btn transition-colors duration-200 px-3 py-2 rounded-lg text-sm font-medium shadow-sm flex items-center gap-1
                                        {% if sym.active %}bg-green-500 hover:bg-green-600 text-white{% else %}bg-gray-400 hover:bg-gray-500 text-white{% endif %}">
                                    {% if sym.active %}🟢 Active{% else %}🔴 Stopped{% endif %}
                                </button>

                                <!-- Panic Close -->
                                <button data-symbol="{{ sym.name }}" class="panic-close-btn transition-colors duration-200 px-3 py-2 rounded-lg text-sm font-medium shadow-sm flex items-center gap-1 bg-red-500 hover:bg-red-600 text-white">
                                    ⚠ Panic Close
                                </button>

                                <!-- Cancel Orders -->
                                <button data-symbol="{{ sym.name }}" class="cancel-orders-btn transition-colors duration-200 px-3 py-2 rounded-lg text-sm font-medium shadow-sm flex items-center gap-1 bg-yellow-400 hover:bg-yellow-500 text-gray-900">
                                    ✖ Cancel Orders
                                </button>

                                <!-- Edit -->
                                <button data-symbol="{{ sym.name }}" class="edit-symbol-btn transition-colors duration-200 px-3 py-2 rounded-lg text-sm font-medium shadow-sm flex items-center gap-1 bg-blue-500 hover:bg-blue-600 text-white">
                                    ✎ Edit
                                </button>

                                <!-- Remove -->
                                <form method="POST" class="m-0">
                                    <input type="hidden" name="remove_symbol" value="{{ sym.name }}">
                                    <button type="submit" class="transition-colors duration-200 px-3 py-2 rounded-lg text-sm font-medium shadow-sm flex items-center gap-1 bg-gray-500 hover:bg-gray-600 text-white">
                                        🗑 Remove
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" class="text-center py-6 text-gray-500">No symbols added yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// --- Symbol Dropdown ---
const input = document.getElementById('symbolInput');
const dropdown = document.getElementById('symbolDropdown');
const items = dropdown.querySelectorAll('div');

input.addEventListener('focus', () => dropdown.classList.remove('hidden'));
document.addEventListener('click', e => {
    if (!dropdown.contains(e.target) && e.target !== input) dropdown.classList.add('hidden');
});
input.addEventListener('input', () => {
    const val = input.value.toLowerCase();
    let hasMatch = false;
    items.forEach(item => {
        const match = item.textContent.toLowerCase().includes(val);
        item.style.display = match ? 'block' : 'none';
        if(match) hasMatch = true;
    });
    dropdown.classList.toggle('hidden', !hasMatch);
});
items.forEach(item => item.addEventListener('mousedown', e => {
    e.preventDefault();
    input.value = item.textContent;
    dropdown.classList.add('hidden');
}));

// --- Utility to set disabled look ---
function setDisabledButton(btn, disabled) {
    if(!btn) return;
    btn.disabled = disabled;
    if(disabled) {
        btn.classList.add("opacity-50", "cursor-not-allowed");
    } else {
        btn.classList.remove("opacity-50", "cursor-not-allowed");
    }
}

// --- Elements for SL handling ---
const stopLossRadios = document.querySelectorAll('.stoploss-mode');
const stopLossInput = document.getElementById('stopLossInput'); // VISIBLE - no name
const stopLossHidden = document.getElementById('stopLossHidden'); // HIDDEN - has name

// --- Elements for FarClose handling ---
const farCloseRadios = document.querySelectorAll('.farclose-radio');

// Update UI and hidden value based on mode
function updateStopLossUI() {
    const selected = document.querySelector('input[name="stop_loss_mode"]:checked').value;
    if(selected === 'same_price') {
        stopLossInput.value = "0.0";
        stopLossInput.readOnly = true;
        stopLossHidden.value = "0.0";
    } else if(selected === 'no_stop') {
        stopLossInput.value = "";
        stopLossInput.readOnly = true;
        stopLossHidden.value = ""; // backend will treat empty as None
    } else { // custom
        stopLossInput.readOnly = false;
        if(stopLossHidden.value && parseFloat(stopLossHidden.value) > 0) {
            stopLossInput.value = parseFloat(stopLossHidden.value).toFixed(4);
        } else {
            stopLossInput.value = "";
            stopLossHidden.value = "";
        }
    }
}

// when visible custom input changes, update hidden value
stopLossInput.addEventListener('input', () => {
    const v = stopLossInput.value.trim();
    stopLossHidden.value = v;
});

stopLossRadios.forEach(r => r.addEventListener('change', updateStopLossUI));

// --- Initialize on load (fixes refresh issue) ---
document.addEventListener('DOMContentLoaded', () => {
    // init buttons state
    document.querySelectorAll('tr.hover\\:bg-gray-50').forEach(row => {
        const toggleBtn = row.querySelector('.toggle-trading-btn');
        const panicBtn = row.querySelector('.panic-close-btn');
        const cancelBtn = row.querySelector('.cancel-orders-btn');
        const editBtn = row.querySelector('.edit-symbol-btn');

        const isActive = toggleBtn && (toggleBtn.classList.contains('bg-green-500') || toggleBtn.textContent.includes('🟢'));
        setDisabledButton(panicBtn, !!isActive);
        setDisabledButton(cancelBtn, !!isActive);
        setDisabledButton(editBtn, !!isActive);
    });

    // init SL UI/hidden
    updateStopLossUI();
});

// --- Form submit validation and final hidden sync ---
const addForm = document.getElementById('addSymbolForm');
addForm.addEventListener('submit', (e) => {
    const mode = document.querySelector('input[name="stop_loss_mode"]:checked').value;
    if(mode === 'custom') {
        const v = stopLossHidden.value.trim();
        if(v === "" || isNaN(v) || parseFloat(v) <= 0) {
            e.preventDefault();
            alert("Custom Stop Loss must be a number greater than 0.0");
            stopLossInput.focus();
            return;
        }
        stopLossHidden.value = parseFloat(v).toFixed(4);
    } else if(mode === 'no_stop') {
        stopLossHidden.value = "";
    } else { // same_price
        stopLossHidden.value = "0.0";
    }

    // ensure farClose radio exists and sends value ("true" or "false")
    // nothing extra needed here because radio has name="farClose" and will be submitted
});

// --- Edit Button (populate form, including farClose) ---
document.querySelectorAll(".edit-symbol-btn").forEach(btn => {
    btn.addEventListener('click', () => {
        if(btn.disabled) return;
        const row = btn.closest('tr');
        input.value = row.children[0].textContent;
        document.querySelector('input[name="lot_size"]').value = row.children[1].textContent;
        document.querySelector('input[name="brick_size"]').value = parseFloat(row.children[2].textContent).toFixed(4);
        document.querySelector('input[name="max_up"]').value = row.children[3].textContent;
        document.querySelector('input[name="max_down"]').value = row.children[4].textContent;
        document.querySelector('select[name="trade_side"]').value = row.children[5].textContent;

        // Determine SL radio and hidden value based on displayed cell
        const slText = row.children[6].textContent.trim();
        if(slText === "—") {
            document.querySelector('input[name="stop_loss_mode"][value="no_stop"]').checked = true;
            stopLossHidden.value = "";
        } else {
            const slNum = parseFloat(slText);
            if(!isNaN(slNum) && slNum === 0.0) {
                document.querySelector('input[name="stop_loss_mode"][value="same_price"]').checked = true;
                stopLossHidden.value = "0.0";
            } else {
                document.querySelector('input[name="stop_loss_mode"][value="custom"]').checked = true;
                stopLossHidden.value = (!isNaN(slNum) ? slNum.toFixed(4) : "");
            }
        }

        // Now update visible + readonly state from hidden
        updateStopLossUI();

        document.querySelector('input[name="take_profit_pips"]').value = row.children[7].textContent !== "—" ? parseFloat(row.children[7].textContent).toFixed(4) : "";
        document.querySelector('input[name="trailing_stop_pips"]').value = row.children[8].textContent !== "—" ? parseFloat(row.children[8].textContent).toFixed(4) : "";

        // --- NEW: populate farClose radio from row's data attribute ---
        const farCloseVal = row.dataset.farclose === 'true' ? 'true' : 'false';
        const targetRadio = document.querySelector(`input[name="farClose"][value="${farCloseVal}"]`);
        if(targetRadio) targetRadio.checked = true;

        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
});

// --- Toggle Trading Button ---
document.querySelectorAll(".toggle-trading-btn").forEach(btn => {
    btn.addEventListener('click', async () => {
        const symbol = btn.dataset.symbol;

        const res = await fetch("/symbols/toggle", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ symbol })
        });

        const data = await res.json();
        if(data.success) {
            const row = btn.closest('tr');
            const panicBtn = row.querySelector(".panic-close-btn");
            const cancelBtn = row.querySelector(".cancel-orders-btn");
            const editBtn = row.querySelector(".edit-symbol-btn");

            if(data.active) {
                btn.classList.remove("bg-gray-400", "hover:bg-gray-500");
                btn.classList.add("bg-green-500", "hover:bg-green-600");
                btn.textContent = "🟢 Active";

                setDisabledButton(panicBtn, true);
                setDisabledButton(cancelBtn, true);
                setDisabledButton(editBtn, true);
            } else {
                btn.classList.remove("bg-green-500", "hover:bg-green-600");
                btn.classList.add("bg-gray-400", "hover:bg-gray-500");
                btn.textContent = "🔴 Stopped";

                setDisabledButton(panicBtn, false);
                setDisabledButton(cancelBtn, false);
                setDisabledButton(editBtn, false);
            }
        }
    });
});

// --- Panic Close & Cancel Orders Buttons ---
document.querySelectorAll(".panic-close-btn, .cancel-orders-btn").forEach(btn => {
    btn.addEventListener('click', async () => {
        if(btn.disabled) return;

        const symbol = btn.dataset.symbol;
        const action = btn.classList.contains("panic-close-btn") ? "panic-close" : "close-pending";
        const confirmMsg = action === "panic-close"
            ? `⚠ Are you sure you want to force close all ${symbol} trades?`
            : `⚠ Are you sure you want to cancel all pending orders for ${symbol}?`;

        if(!confirm(confirmMsg)) return;

        btn.disabled = true;
        btn.textContent = "⏳ Processing...";

        try {
            const res = await fetch(`/symbols/${action}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ symbol })
            });

            const data = await res.json();
            if(data.success) {
                alert(`✅ Successfully executed ${action} for ${symbol}`);
            } else {
                alert(`❌ Failed: ${data.message || "Unexpected error"}`);
            }
        } catch (err) {
            alert("⚠ Error connecting to server.");
        }

        btn.disabled = false;
        btn.textContent = action === "panic-close" ? "⚠ Panic Close" : "✖ Cancel Orders";
    });
});
</script>
{% endblock %}
