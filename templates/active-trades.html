{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto mt-10 px-4">
    <h1 class="text-5xl font-extrabold text-center mb-10 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-purple-500 to-pink-500 drop-shadow-lg">
        ðŸš€ Active Trades Dashboard
    </h1>

    <!-- Filter Dropdown -->
    <div class="flex flex-wrap justify-center gap-4 mb-8">
        <label class="font-semibold text-gray-700 dark:text-gray-300 self-center">Filter by Symbol:</label>
        <select id="symbolFilter" class="border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 bg-white dark:bg-gray-800 text-gray-800 dark:text-white shadow-md focus:ring-2 focus:ring-purple-500">
            <option value="">All</option>
            {% for s in symbols %}
                <option value="{{ s }}" {% if selected_symbol == s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
        </select>
        <button id="applyFilter" class="bg-gradient-to-r from-purple-600 to-pink-500 hover:from-pink-500 hover:to-purple-600 text-white px-5 py-2 rounded-lg font-bold shadow-lg transition-transform transform hover:scale-105">
            Apply
        </button>
    </div>

    <!-- Trades Table -->
    <div class="overflow-x-auto bg-white dark:bg-gray-900 bg-opacity-70 backdrop-blur-md rounded-xl p-4 border border-gray-300 dark:border-gray-700">
        <table id="tradesTable" class="w-full table-auto border border-gray-300 dark:border-gray-700 text-sm md:text-base">
            <thead class="bg-gradient-to-r from-gray-700 to-gray-900 text-white">
                <tr>
                    <th class="border border-gray-300 dark:border-gray-700 px-4 py-3 text-left">Symbol</th>
                    <th class="border border-gray-300 dark:border-gray-700 px-4 py-3 text-center">Type</th>
                    <th class="border border-gray-300 dark:border-gray-700 px-4 py-3 text-center">Lot</th>
                    <th class="border border-gray-300 dark:border-gray-700 px-4 py-3 text-center">Price Open</th>
                    <th class="border border-gray-300 dark:border-gray-700 px-4 py-3 text-center">Current Price</th>
                    <th class="border border-gray-300 dark:border-gray-700 px-4 py-3 text-center">Profit / Loss</th>
                    <th class="border border-gray-300 dark:border-gray-700 px-4 py-3 text-center">Ticket</th>
                </tr>
            </thead>
            <tbody class="text-gray-800 dark:text-gray-200">
                {% for p in trades %}
                <tr class="hover:bg-gray-100 dark:hover:bg-gray-800 transition duration-200">
                    <td class="border border-gray-300 dark:border-gray-700 px-4 py-2 font-semibold">{{ p.symbol }}</td>
                    <td class="border border-gray-300 dark:border-gray-700 px-4 py-2 text-center">
                        <span class="{{ 'text-green-500 font-bold' if p.type == 'Buy' else 'text-red-500 font-bold' }}">{{ p.type.upper() }}</span>
                    </td>
                    <td class="border border-gray-300 dark:border-gray-700 px-4 py-2 text-center">{{ p.volume }}</td>
                    <td class="border border-gray-300 dark:border-gray-700 px-4 py-2 text-center">{{ p.price_open }}</td>
                    <td class="border border-gray-300 dark:border-gray-700 px-4 py-2 text-center">{{ p.price_current }}</td>
                    <td class="border border-gray-300 dark:border-gray-700 px-4 py-2 text-center font-bold {{ 'text-green-500' if p.profit >=0 else 'text-red-500' }}">{{ "%.2f"|format(p.profit) }}</td>
                    <td class="border border-gray-300 dark:border-gray-700 px-4 py-2 text-center">{{ p.ticket }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- No Trades Alert -->
    <div id="noTradesAlert" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 mt-6 rounded-lg shadow-md">
        <p><strong>No active trades found.</strong></p>
    </div>
</div>

<script>
const tradesTable = document.getElementById("tradesTable").getElementsByTagName('tbody')[0];
const symbolFilter = document.getElementById("symbolFilter");

async function fetchTrades() {
    const symbol = symbolFilter.value;
    const url = symbol ? `/api/trades?symbol=${symbol}` : '/api/trades';

    try {
        const res = await fetch(url);
        const data = await res.json();

        tradesTable.innerHTML = '';
        if (!data.trades || data.trades.length === 0) {
            document.getElementById('noTradesAlert').classList.remove('hidden');
        } else {
            document.getElementById('noTradesAlert').classList.add('hidden');
            data.trades.forEach(p => {
                const row = tradesTable.insertRow();
                row.className = 'hover:bg-gray-100 dark:hover:bg-gray-800 transition duration-200';
                row.innerHTML = `
                    <td class="border border-gray-300 dark:border-gray-700 px-4 py-2 font-semibold">${p.symbol}</td>
                    <td class="border border-gray-300 dark:border-gray-700 px-4 py-2 text-center">
                        <span class="${p.type === 'Buy' ? 'text-green-500 font-bold' : 'text-red-500 font-bold'}">${p.type.toUpperCase()}</span>
                    </td>
                    <td class="border border-gray-300 dark:border-gray-700 px-4 py-2 text-center">${p.volume}</td>
                    <td class="border border-gray-300 dark:border-gray-700 px-4 py-2 text-center">${p.price_open}</td>
                    <td class="border border-gray-300 dark:border-gray-700 px-4 py-2 text-center">${p.price_current}</td>
                    <td class="border border-gray-300 dark:border-gray-700 px-4 py-2 text-center font-bold ${p.profit >= 0 ? 'text-green-500' : 'text-red-500'}">${parseFloat(p.profit).toFixed(2)}</td>
                    <td class="border border-gray-300 dark:border-gray-700 px-4 py-2 text-center">${p.ticket}</td>
                `;
            });
        }
    } catch (err) {
        console.error("Failed to fetch trades:", err);
    }
}

setInterval(fetchTrades, 1000);
document.getElementById('applyFilter').addEventListener('click', fetchTrades);
</script>
{% endblock %}